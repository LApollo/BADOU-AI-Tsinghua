from matplotlib.collections import PolyCollection
import matplotlib.pyplot as plt
import numpy as np


def polygon_under_graph(xx, yy):
    """
    Construct the vertex list which defines the polygon filling the space under
    the (x, y) line graph. This assumes x is in ascending order.
    """
    return [(xx[0], 0.), *zip(xx, yy), (xx[-1], 0.)]


if __name__ == '__main__':
    # 导入训练日志原始数据
    # loss_by_epoch = [108.97773790359497, 108.75025326013565, 108.79755055904388, 105.29072165489197,
    #                  97.98961937427521, 94.25211700797081, 87.47383204102516, 80.6106770336628, 74.6193336546421,
    #                  67.6096903681755, 63.97555139660835, 59.85419824719429, 57.42746886610985, 51.73873822391033,
    #                  48.42833535373211]
    loss_by_mini_batches = [0.7000449776649476, 0.6946147044499715, 0.6941069046656291, 0.69302396774292,
                            0.6938712557156881, 0.6937415719032287, 0.6930826942125956, 0.693166176478068,
                            0.6929360707600911, 0.6933260798454285, 0.6936220486958822, 0.6910975575447083,
                            0.6878230253855387, 0.6913297295570373, 0.6938600579897563, 0.6949583729108174,
                            0.693545150756836, 0.6936178604761759, 0.6934328436851501, 0.6934268434842428,
                            0.6935029983520508, 0.6933597445487976, 0.6936174670855204, 0.6930736581484477,
                            0.6928394516309102, 0.6931686917940776, 0.6912480791409811, 0.692776358127594,
                            0.6929285407066346, 0.6919805010159811, 0.6911401828130086, 0.6814328551292419,
                            0.6918096582094828, 0.6867833773295084, 0.6897326389948527, 0.6825289249420166,
                            0.6600207567214966, 0.6660476406415303, 0.6391542156537374, 0.6404157161712647,
                            0.6604226112365723, 0.6403311967849732, 0.6310357252756754, 0.633210297425588,
                            0.6232601761817932, 0.6175873716672261, 0.6230621298154195, 0.6133535782496135,
                            0.6105008641878764, 0.596320374806722, 0.5930845260620117, 0.6228784839312236,
                            0.6186772108078002, 0.6084754824638366, 0.6065666596094768, 0.6138473192850749,
                            0.5879809776941936, 0.5881612340609232, 0.5808477520942688, 0.5898977319399515,
                            0.5723574121793111, 0.5595563451449076, 0.5450664738814036, 0.5787750124931336,
                            0.5408566037813822, 0.563014821211497, 0.5609603802363078, 0.554148652156194,
                            0.5397224466005961, 0.5581002791722616, 0.5387393335501353, 0.509161506096522,
                            0.5196850458780925, 0.5295849780241648, 0.5140472054481506, 0.5139276146888733,
                            0.5124896208445231, 0.5238624393939972, 0.4911988079547882, 0.49906076192855836,
                            0.5026551445325216, 0.4902829110622406, 0.4814930160840352, 0.48747016390164694,
                            0.4536252021789551, 0.4780574103196462, 0.49184542695681255, 0.4560535788536072,
                            0.4542385737101237, 0.4735949635505676, 0.43847910364468895, 0.4262838264306386,
                            0.4350076933701833, 0.4250426630179087, 0.4448293248812358, 0.4417108337084452,
                            0.4254556059837341, 0.4224832892417908, 0.38618068893750507, 0.44532978932062783,
                            0.39067715406417847, 0.4121850570042928, 0.4011631270249685, 0.4351079305013021,
                            0.4179663340250651, 0.37977263927459715, 0.41203747590382894, 0.4039345482985179,
                            0.41996700565020245, 0.39585458834966025, 0.383293890953064, 0.3567477961381276,
                            0.3702202280362447, 0.376684433221817, 0.37963128089904785, 0.4126274824142456,
                            0.4065552135308584, 0.36716660658518474, 0.3944107155005137, 0.36948994795481366,
                            0.33531366984049477, 0.3844947556654612, 0.35684333046277367, 0.3510000785191854,
                            0.34786106944084166, 0.38532519539197285, 0.3713599642117818, 0.3731728374958038,
                            0.3532807429631551, 0.3994641403357188, 0.3682519872983297, 0.3317381719748179,
                            0.315013196070989, 0.31384227275848386, 0.3356974641482035, 0.3348026116689046,
                            0.3270806352297465, 0.3510709643363953, 0.31209963162740073, 0.3081172496080399,
                            0.32129491567611695, 0.2989696115255356, 0.29110621015230814, 0.30238553484280906,
                            0.3124387035767237, 0.3261612226565679, 0.3212801595528921, 0.29342598021030425,
                            0.305833841363589, 0.3115789552529653]

    # 由于训练时代码漏掉了除以数据个数和batch size，这里要除一下
    # loss_by_epoch = np.array(loss_by_epoch) / 20000 * 128
    # 将每20个mini-batches一采样输出的loss变成二维(行代表epoch，列代表采样次数)
    loss_by_mini_batches = np.array(loss_by_mini_batches).reshape((15, 10)).T

    # 作图部分，参考matplotlib官网教程
    plt.rcParams['font.sans-serif'] = ['simhei']
    ax = plt.figure(figsize=(12, 9), dpi=600).add_subplot(projection='3d')

    x = np.linspace(1, 10, 10, dtype=int)
    lambdas = range(15)

    # verts[i] is a list of (x, y) pairs defining polygon i.
    verts = [polygon_under_graph(x, loss_by_mini_batches[:, l]) for l in lambdas]
    facecolors = plt.colormaps['viridis_r'](np.linspace(0, 1, len(verts)))

    poly = PolyCollection(verts, facecolors=facecolors, alpha=0.7)
    ax.add_collection3d(poly, zs=lambdas, zdir='y')

    ax.set(xlim=(0, 10), ylim=(0, 15), zlim=(0, 0.8),
           xlabel='Epoch', ylabel=r'$\lambda$ * 15 mini-batches', zlabel='loss')

    ax.set_title("Loss随训练过程的变化趋势图")
    ax.view_init(30, 135)
    plt.show()
